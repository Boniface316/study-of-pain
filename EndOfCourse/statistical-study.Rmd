---
title: "Statistical study of backpain"
author: "s1899215"
date: "February 10, 2019"
output: pdf_document
---


```{r library, echo=FALSE,warning=FALSE, message=FALSE}
library(ggplot2)
library(readxl)
library(knitr)
library(reshape2)
library(gridExtra)
library(stringr)
library(dplyr)
library(data.table)
```

```{r function, echo = FALSE, warning = FALSE,message=FALSE, eval=FALSE}
#TODO: Not required 
seperateBiomarkerData <- function(nameOfBiomarker, biomarkerData) {
  seperatedData <- biomarkerDataClean[,nameOfBiomarker]
  seperatedData <- cbind(biomarkerData[,2], seperatedData)
  assign(nameOfBiomarker, seperatedData, envir = .GlobalEnv)
}

#TODO: Not required
minMaxNorm <- function(x){
  r <- (x-min(x))/(max(x)-min(x))
  return(r)
}

#TODO: Not required
transformEachBiomarker <- function(nameOfBiomarker) {
  data <- get(nameOfBiomarker, envir = .GlobalEnv)
  data <- data %>% 
    mutate(logScale = log(data[,2]),
           zscore = scale(data[,2]),
           sqrt = sqrt(data[,2]),
           squared = data[,2]^2,
           minMax = minMaxNorm(data[,2]))
  colnames(data)[2] <- "Raw"
  assign(nameOfBiomarker, data, envir = .GlobalEnv)
}

#TODO:Not required
meltBiomarkers <- function(nameOfBiomarker) {
  data <- get(nameOfBiomarker, envir = .GlobalEnv)
  data <- melt(data = data, id.vars = "WeeksObs")
  nameOfData <- paste0(nameOfBiomarker,".Melt")
  assign(nameOfData, data, envir = .GlobalEnv)
}

```


```{r load data, echo=FALSE, warning=FALSE, message = FALSE}
biomarkerFile <- "biomarkers.xlsx"
covariateFile <- "covariates.xlsx"

biomarkerFilePath <- paste0(getwd(),"/data/",biomarkerFile)
covariateFilePath <- paste0(getwd(),"/data/",covariateFile)

biomarkerData <- read_xlsx(biomarkerFilePath)
covariateData <- read_xlsx(covariateFilePath)
biomarkerData <- as.data.table(biomarkerData)
covariateData <- as.data.table(covariateData)
```

# 2 Exploring Raw data

## 2.1 Biomarker data

```{r biomarker data, echo = FALSE}
#kable(biomarkerData[1:5,], caption = " Biomarker raw data")
#na.Table <- colSums(is.na(biomarkerData))
#na.Table <- data.frame("Number of NA" = na.Table)
#kable(na.Table, caption = " NAs in Biomarker raw data")
#biomarkerDataClean <- biomarkerData[complete.cases(biomarkerData),]

#Number of observations in raw file
BioMarkerNumOfObservationsRaw <- nrow(biomarkerData)

#Sample display of the raw file
kable(biomarkerData[1:5,], caption = " Biomarker raw data")

#Table with NAs in the data
kable(biomarkerData[, lapply(.SD, function(x) sum(is.na(x))), 
                    .SDcols = 1:ncol(biomarkerData)], caption = "NAs in Biomarker data")

#Remove rows that contains NA
biomarkerData <- na.omit(biomarkerData)

```

From the Biomarker data we observed the following:

`r paste0("Number of observations: ", BioMarkerNumOfObservationsRaw)`


`r paste0("Number of columns (proteins tested): ", ncol(biomarkerData))`


`r BioMarkerNumOfObservationsRaw - nrow(biomarkerData)`  rows contain NA values in the raw data. These rows are removed from the data, as the NAs can cause some errors in  our calcuation. 

The Biomaker column contains both patientID and the time the test was conducted. Therefore this needs to be extracted and registered in seperate columns. 

## 2.2 Patient data
```{r patient data, echo = FALSE}
#Number of observations from Covariate data
CovNumOfObservationsRaw <- nrow(covariateData)

#Sample display of covariate data
kable(covariateData[1:5,], caption = " Covariates raw data")

#Summary table of NAs in the data
kable(covariateData[,lapply(.SD, function(x) sum(is.na(x))), 
                    .SDcols = 1:ncol(covariateData)], caption = "NAs in Covariate data")

#Remove the rows that contains NAs
covariateData <- na.omit(covariateData)
```

`r paste0("Number of observations: ", CovNumOfObservationsRaw)`


`r paste0("Number of columns: ", ncol(covariateData))`


`r nrow(biomarkerData) - CovNumOfObservationsRaw`

## 2.2.1 Patient data - simple analysis
```{r patient data clean, echo=FALSE}
setnames(covariateData, c("Sex (1=male, 2=female)", "Smoker (1=yes, 2=no)","VAS-at-inclusion", "Vas-12months"), c("Sex", "Smoker", "VAS.Inclusion", "VAS.12Months"))

covariateData[,Sex := factor(ifelse(Sex == 1, "Male", "Female"))]
covariateData[,Smoker := factor(ifelse(Smoker == 1, "Yes", "No"))]

covariateDataMelt <- melt(covariateData, id.vars = c("PatientID", "Age", "Sex", "Smoker"))
```

```{r patient-data-simple-analysis, echo = FALSE, message=FALSE, comment=NA}
ggplot(data = covariateData, aes(x = Age)) +
  geom_bar(aes(fill = Smoker)) + 
  xlab("Age") +
  ggtitle("Number of smokers in each Age group")

invisible(ggsave(paste0(getwd(),"/plot/","Smokers-Age.jpg")))

ggplot(data = covariateData, aes(x = Age)) +
  geom_bar(aes(fill = Sex)) +
  xlab("Age") +
  ggtitle("Different sex in each age group")

invisible(ggsave(paste0(getwd(),"/plot/","Sex-Age.jpg")))

ggplot(covariateDataCleanMelt, aes(x = variable, y = value)) +
  geom_boxplot(fill = "#4271AE") +
  xlab("VAS") +
  ylab("VAS score") +
  ggtitle("Comparing VAS at inclusion and at 12 months")

invisible(ggsave(paste0(getwd(),"/plot/","VAS-overall.jpg")))

VAS.ComparrisonSexGraph <- ggplot(covariateDataCleanMelt, aes(x = variable, y = value, fill = Sex)) +
  geom_boxplot() +
  xlab("VAS") +
  ylab("VAS score") +
  ggtitle("Comparing VAS on sex")

invisible(ggsave(paste0(getwd(),"/plot/","VAS-Sex.jpg")))

VAS.ComparrisonSmokersGraph <- ggplot(covariateDataCleanMelt, aes(x = variable, y = value, fill = Smoker)) +
  geom_boxplot() +
  xlab("VAS") +
  ylab("VAS score") +
  ggtitle("Comparing VAS on smokers")

invisible(ggsave(paste0(getwd(),"/plot/","VAS-Smokers.jpg")))
grid.arrange(VAS.ComparrisonSexGraph,VAS.ComparrisonSmokersGraph,ncol = 2)
```

# 3 Cleaning/Manipulating Data
```{r Biomarker-data-manupilation, echo=FALSE, eval=FALSE}
biomarkerDataClean$PatientID <- as.factor(sub("\\-.*", "", biomarkerDataClean$Biomarker))
extractedTime <- sub(".*-", "", biomarkerDataClean$Biomarker)
extractedTime <- gsub("[^0-9.]", "",  extractedTime)
extractedTime[which(extractedTime == 12)] <- 52
biomarkerDataClean$WeeksObs <- as.factor(extractedTime)
levels(biomarkerDataClean$WeeksObs) <- c("0","6","52")

biomarkerDataClean <- biomarkerDataClean[,c("PatientID","WeeksObs","IL-8","VEGF-A","OPG","TGF-beta-1","IL-6",
                                             "CXCL9","CXCL1","IL-18","CSF-1" )]
kable(head(biomarkerDataClean,10))
```

```{r Biomarker-graph-slope, echo = FALSE, eval=FALSE}
biomarkerDataCleanGrouped <- aggregate(biomarkerDataClean[,3:ncol(biomarkerDataClean)], list(biomarkerDataClean$WeeksObs), mean)
ColNamesBiomarkerData <- colnames(biomarkerDataClean[,2:ncol(biomarkerDataClean)])

colnames(biomarkerDataCleanGrouped) <- ColNamesBiomarkerData
#levels(biomarkerDataCleanGrouped$WeeksObs) <- c("0","6","52")

biomarkerMelt <- melt(biomarkerDataCleanGrouped, id.vars = "WeeksObs")

ggplot(data = biomarkerMelt, aes(x = WeeksObs, y = value, group = variable)) +
  geom_line(color = "blue") +
  facet_wrap(~variable) +
  xlab("Week observed") +
  ylab("Protein level") +
  ggtitle("Protein levels in blood samples at 0,6 and 52 weeks ")

invisible(ggsave(paste0(getwd(),"/plot/","Protein-levels.jpg")))

biomarkerScaled <- lapply(biomarkerDataClean[,c(-1,-2)], function(x) (x-min(x))/(max(x)-min(x)))
biomarkerScaled <- do.call(cbind, biomarkerScaled)
biomarkerScaled <- data.frame(biomarkerScaled)
colnames(biomarkerScaled) <- ColNamesBiomarkerData[-1]

biomarkerScaled <- cbind(biomarkerDataClean[,1:2],biomarkerScaled)
biomarkerScaledGrouped<- aggregate(biomarkerScaled[,3:ncol(biomarkerScaled)], list(biomarkerScaled$WeeksObs), mean)
colnames(biomarkerScaledGrouped) <-  ColNamesBiomarkerData
#levels(biomarkerScaledGrouped$WeeksObs) <- c("0","6","52")

biomarkerScaledGroupedMelt <- melt(biomarkerScaledGrouped, id.vars = "WeeksObs")

ggplot(data = biomarkerScaledGroupedMelt, aes(x = WeeksObs, y = value, group = variable)) +
  geom_line(color = "blue") +
  facet_wrap(~variable) +
  xlab("Week observed") +
  ylab("Scaled protein level") +
  ggtitle("Scaled protein levels in blood samples at 0,6 and 52 weeks ")

invisible(ggsave(paste0(getwd(),"/plot/","Scaled-protein-levels.jpg")))
```

[Reference for scaling](https://books.google.ca/books?id=0HJuBwAAQBAJ&pg=PA30&lpg=PA30&dq=data+mining+and+predictive+analytics+min(X)&source=bl&ots=ox5witbZxC&sig=ACfU3U34l8OoM7Zi1YisENbjSwRKlla8RQ&hl=en&sa=X&ved=2ahUKEwjc5tT4xLngAhUSX60KHSjsAMoQ6AEwCnoECAkQAQ# v=onepage&q=data%20mining%20and%20predictive%20analytics%20min(X)&f=false)

```{r VAS-difference-covData, echo = FALSE, message=FALSE, eval=FALSE}
covariateDataClean$PainDiff <- covariateDataClean$`12mos` - covariateDataClean$Inclusion
covDataVAS.Increase <- covariateDataClean[which(covariateDataClean$PainDiff >= 0), ]

kable(covDataVAS.Increase, caption = "Patients with increased VAS after 12 months")
```


r nrow(covDataVAS.Increase)  patients reported to have higher VAS compared to inclusion.

r length(which(covDataVAS.Increase$Sex == "Female")) female patients and r length(which(covDataVAS.Increase$Sex == "Male")) male patients infomed drugs were not helpful

r length(which(covDataVAS.Increase$Smoker == "Smoker"))` Smokers and  `r length(which(covDataVAS.Increase$Smoker == "Non-Smoker"))  non smokers


```{r VAS-difference-covData-31-patients, echo=FALSE, message=FALSE, eval=FALSE}
covariateDataVAS.IncreaseMelt <- melt(covDataVAS.Increase, id.vars = c("patientID", "Age", "Sex", "Smoker", "PainDiff"))

ggplot(data = covariateDataVAS.IncreaseMelt, aes(x = variable, y = value))  +
  geom_boxplot(fill = "#4271AE") +
  xlab("VAS") +
  ylab("VAS score") +
  ggtitle("Comparing VAS of patients with increased VAS at 12 months")
```


```{r pain-distribution, echo=FALSE, eval=FALSE}
painDiffMean<- aggregate(scale(covariateDataClean$PainDiff), list(covariateDataClean$Sex), mean)

colnames(painDiffMean) <- c("Sex", "Mean")

ggplot(covariateDataClean, aes(x=scale(PainDiff), colour=Sex)) +
  geom_density() +
  geom_vline(data=painDiffMean, aes(xintercept=Mean,  colour=Sex),
             linetype="dashed", size=1) + 
  xlab("Scaled Difference of VAS") +
  ylab("Count") +
  ggtitle("Distribution of Difference of VAS")

```

# Transform Biomarkers

```{r transform-each-biomarker, message=FALSE, echo=FALSE,warning=FALSE, eval=FALSE}
namesBiomaker  <- colnames(biomarkerData)[2:ncol(biomarkerData)]

invisible(lapply(namesBiomaker, FUN = seperateBiomarkerData, biomarkerData = biomarkerDataClean))
invisible(lapply(namesBiomaker,transformEachBiomarker))
invisible(lapply(namesBiomaker, meltBiomarkers))

ggplot(data = `IL-8.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("IL-8")


ggplot(data = `VEGF-A.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("VEGF-A")

ggplot(data = OPG.Melt, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("OPG")

ggplot(data = `TGF-beta-1.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("TGF-beta-1")

ggplot(data = `IL-6.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("IL-6")

ggplot(data = CXCL9.Melt, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("CXCL9")

ggplot(data = CXCL1.Melt, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("CXCL1")


ggplot(data = `IL-18.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("IL-18")

ggplot(data = `CSF-1.Melt`, aes(x = value, fill = WeeksObs)) +
  geom_density(alpha = 0.25) +
  facet_wrap(~variable, scales = "free") +
  ggtitle("CSF-1")
```

Based on all of these graphs, zscore transformation seems to be the most suitable transformation which provides us Normal distribution.

```{r merging data, echo=FALSE, message = FALSE, eval=FALSE}
mergedBiomarkerCovariateData <- merge(biomarkerDataClean, covariateDataClean, by.x = "PatientID", by.y = "patientID")
tableOfPatientDataWeeksObs <- table(mergedBiomarkerCovariateData$WeeksObs)
tableOfPatientDataWeeksObs <- as.data.frame(tableOfPatientDataWeeksObs)
colnames(tableOfPatientDataWeeksObs) <- c("WeeksObs", "Frequency")
#levels(tableOfPatientDataWeeksObs$WeeksObs) <- c("0","6","52") 
kable(tableOfPatientDataWeeksObs, caption = "Frequency of observation")
```

It appears that some patient's biomarker records are missing. In order to move forward, we will examine the patients that are missing the records.

```{r patients-biomarker-missing-data,echo=FALSE, message=FALSE, eval=FALSE}
#biomarkerByPatient <- aggregate(as.numeric(mergedBiomarkerCovariateData$PatientID), list(mergedBiomarkerCovariateData$PatientID), sum)
#colnames(biomarkerByPatient) <- c("PatientID", "FreqObs")
biomarkerByPatientCount <- data.table(sort(table(mergedBiomarkerCovariateData$PatientID)))
setnames(biomarkerByPatientCount, c("V1", "N"), c("PatientID", "ObservationCount"))
biomarkerByPatientCount <- biomarkerByPatientCount[ObservationCount == 3]

mergedBiomarkerCovariateDT <- as.data.table(mergedBiomarkerCovariateData)
mergedBiomarkerCovariateDT <- biomarkerByPatientCount[mergedBiomarkerCovariateDT, on = .(PatientID)]
mergedBiomarkerCovariateDT <- mergedBiomarkerCovariateDT[!is.na(ObservationCount),]
mergedBiomarkerCovariateDT[, ObservationCount := NULL]
mergedBiomarkerCovariateDT <- mergedBiomarkerCovariateDT[order(PatientID, WeeksObs)]
```

```{r VAS greater than 5, echo=FALSE, message=FALSE, eval=FALSE}
mergedBiomarkerCovariateDT[,HighVAS.Inclusion := factor(ifelse(Inclusion >=5, "Yes", "No"))]

mergedBiomarkerCovariateDT[,HighVAS.After := factor(ifelse(`12mos` >=5, "Yes", "No"))]

kable(summary(mergedBiomarkerCovariateDT$HighVAS.Inclusion), caption = "Greater than 5 or equal VAS at inclusion")
kable(summary(mergedBiomarkerCovariateDT$HighVAS.After), caption = "Greater than 5 or equal VAS at inclusion")
```

