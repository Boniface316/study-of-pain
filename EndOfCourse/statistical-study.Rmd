---
title: "Statistical study of backpain"
author: "s1899215"
date: "February 10, 2019"
output: pdf_document
---

```{r library, echo=FALSE,warning=FALSE, message=FALSE}
library(ggplot2)
library(readxl)
library(knitr)
library(reshape2)
library(gridExtra)
library(stringr)
library(data.table)
```
# 1 Introduction

```{r load data, echo=FALSE, warning=FALSE, message = FALSE}
biomarkerFile <- "biomarkers.xlsx"
covariateFile <- "covariates.xlsx"

biomarkerFilePath <- paste0(getwd(),"/data/",biomarkerFile)
covariateFilePath <- paste0(getwd(),"/data/",covariateFile)

biomarkerData <- read_xlsx(biomarkerFilePath)
covariateData <- read_xlsx(covariateFilePath)
biomarkerData <- as.data.table(biomarkerData)
covariateData <- as.data.table(covariateData)
```

# 2 Exploring Raw data

## 2.1 Biomarker data

```{r biomarker data, echo = FALSE}
#Number of observations in raw file
BioMarkerNumOfObservationsRaw <- nrow(biomarkerData)

#Sample display of the raw file
kable(biomarkerData[1:5,], caption = " Biomarker raw data")

#Table with NAs in the data
kable(biomarkerData[, lapply(.SD, function(x) sum(is.na(x))), 
                    .SDcols = 1:ncol(biomarkerData)], caption = "NAs in Biomarker data")

#Remove rows that contains NA
biomarkerData <- na.omit(biomarkerData)
```

From the Biomarker data we observed the following:

`r paste0("Number of observations: ", BioMarkerNumOfObservationsRaw)`


`r paste0("Number of columns (proteins tested): ", ncol(biomarkerData))`


`r BioMarkerNumOfObservationsRaw - nrow(biomarkerData)`  rows contain NA values in the raw data. These rows are removed from the data, as the NAs can cause some errors in  our calcuation. 

## 2.2 Patient data

```{r patient raw data, echo = FALSE}
#Number of observations from Covariate data
CovNumOfObservationsRaw <- nrow(covariateData)

#Sample display of covariate data
kable(covariateData[1:5,], caption = " Covariates raw data")

```

```{r patient data number of NAs, echo=FALSE}
#Summary table of NAs in the data
kable(covariateData[,lapply(.SD, function(x) sum(is.na(x))), 
                    .SDcols = 1:ncol(covariateData)], caption = "NAs in Covariate data")

#Remove the rows that contains NAs
covariateData <- na.omit(covariateData)

#Convert PatientID into
covariateData[,PatientID := factor(PatientID)]
```


From the covariate data set we observed the following:

`r paste0("Number of observations: ", CovNumOfObservationsRaw)`


`r paste0("Number of columns: ", ncol(covariateData))`


`r CovNumOfObservationsRaw - nrow(covariateData)` number of rows removed from the orginal data

## 2.2.1 Patient data - simple analysis
```{r patient data clean, echo=FALSE}
#Change the column names of the data
setnames(covariateData, c("Sex (1=male, 2=female)", "Smoker (1=yes, 2=no)","VAS-at-inclusion", "Vas-12months"), c("Sex", "Smoker", "VAS.Inclusion", "VAS.12Months"))

#Saving the names of the columns
covariateColNames <- names(covariateData)

#Change the Sex and Smoker columns from 1 and 2 into corresponding categorical variable
covariateData[,Sex := factor(ifelse(Sex == 1, "Male", "Female"))]
covariateData[,Smoker := factor(ifelse(Smoker == 1, "Yes", "No"))]

#Reshape the data in order to plot easily
covariateDataMelt <- melt(covariateData, id.vars = c("PatientID", "Age", "Sex", "Smoker"))
```

```{r patient-data-age-sex-smoker, echo = FALSE, message=FALSE}
#Plot number of smokers in each age group
g1 <- ggplot(data = covariateData, aes(x = Age)) +
  geom_bar(aes(fill = Smoker)) + 
  xlab("Age") +
  ylab("Count") +
  labs(caption= "Fig 1: number of smokers in each Age group") +
  theme(plot.caption = element_text(hjust = 0))

g2 <- ggplot(data = covariateData, aes(x = Age)) +
  geom_bar(aes(fill = Sex)) +
  xlab("Age") +
  ylab("Count") +
  labs(caption= "Fig 2: Different sex in each age group") +
  theme(plot.caption = element_text(hjust = 0))

grid.arrange(g1,g2,ncol = 2)
```

\vspace{30pt}

```{r patient-data-VAS-comparrison, echo=FALSE, message=FALSE, comment=NA, fig.width=4, fig.height=4}

#Box plot of VAS at inclusion and VAS at months
ggplot(covariateDataMelt, aes(x = variable, y = value)) +
  geom_boxplot(fill = "#4271AE") +
  xlab("VAS") +
  ylab("VAS score") + 
  labs(caption= "Fig 3: Comparing VAS at inclusion and at 12 months") +
  theme(plot.caption = element_text(hjust = 0))
```

\vspace{30pt}

```{r patient-data-VAS-comparrison-Sex, echo=FALSE, message=FALSE, comment=NA}
#VAS comparrison for sex
VAS.ComparrisonSexGraph <- ggplot(covariateDataMelt, aes(x = variable, y = value, fill = Sex)) +
  geom_boxplot() +
  xlab("VAS") +
  ylab("VAS score") + 
  labs(caption= "Fig 4: Comparing VAS on different sex") +
  theme(plot.caption = element_text(hjust = 0), text = element_text(size=10))

#VAS comparrison for smokers
VAS.ComparrisonSmokersGraph <- ggplot(covariateDataMelt, aes(x = variable, y = value, fill = Smoker)) +
  geom_boxplot() +
  xlab("VAS") +
  ylab("VAS score") + 
  labs(caption= "Fig 5: Comparing VAS on smokers") +
  theme(plot.caption = element_text(hjust = 0), text = element_text(size=10))

#Plpot the last two graphs side by side
grid.arrange(VAS.ComparrisonSexGraph,VAS.ComparrisonSmokersGraph,ncol = 2)
```

# 3 Cleaning/Manipulating Data

```{r Biomarker-data-manupilation, echo=FALSE}
#Extract the biomarkers 
biomarkerNames <- colnames(biomarkerData)[2:ncol(biomarkerData)]
#Extract the PatientID from Biomarker Column. Every character before the "-"
biomarkerData[,PatientID :=as.factor(sub("\\-.*", "", biomarkerData$Biomarker))]
#Extracting the characters right of "-" on Biomarker column
extractedTime <- sub(".*-", "", biomarkerData$Biomarker)
#Extract the number from the previous string
extractedTime <- gsub("[^0-9.]", "",  extractedTime)
#Replace 12 months with 52 weeks
extractedTime[which(extractedTime == 12)] <- 52
#Create a new column called WeeksObs which contains the extracted time
biomarkerData[,WeeksObs := factor(extractedTime, levels = c("0","6","52"))]
#Re-arrange the columns
biomarkerData <- setcolorder(biomarkerData, c("PatientID", "WeeksObs", biomarkerNames))
#Remove biomarker column
biomarkerData[,Biomarker := NULL]
#Table of the biomarkerData
kable(head(biomarkerData,10), caption = "Biomarker data after seperating the patient ID and week of observation")
```


```{r Biomarker-weekObs-boxplot, echo = FALSE, fig.width=10, fig.height=10}
#Reshape the data for ease of plotting
biomarkerDataMelt <- melt(biomarkerData, id.vars = c("PatientID", "WeeksObs"))
#Biomarker box plot of each biomarker at each week
ggplot(data = biomarkerDataMelt, aes(x = WeeksObs, y = value)) + 
  geom_boxplot(fill = "#FFD700") +
  facet_wrap(~variable, scales = "free") +
  xlab("Week of Observation") +
  ylab("Biomarker level") + 
  labs(caption= "Fig 6: Biomarker value over the course of week of observation") +
  theme(plot.caption = element_text(hjust = 0), text = element_text(size=16))
```

\vspace{30pt}

[Reference for scaling](https://books.google.ca/books?id=0HJuBwAAQBAJ&pg=PA30&lpg=PA30&dq=data+mining+and+predictive+analytics+min(X)&source=bl&ots=ox5witbZxC&sig=ACfU3U34l8OoM7Zi1YisENbjSwRKlla8RQ&hl=en&sa=X&ved=2ahUKEwjc5tT4xLngAhUSX60KHSjsAMoQ6AEwCnoECAkQAQ# v=onepage&q=data%20mining%20and%20predictive%20analytics%20min(X)&f=false)
                        
```{r VAS-difference-covData, echo = FALSE, message=FALSE}
#Create a new column to get the difference of VAS at inclusion and 12 mos
covariateData[,PainDiff := VAS.Inclusion - VAS.12Months]
                        
VAS.improvement <- covariateData[,Improved := ifelse(PainDiff > 0,"Pain improved","Pain did not improve")]
```

# Question 1:
Choose a question and explain why you chose that

Among the patients that showed improvement, did their biomarker level change at each week of observation. If it did, we may be able to utilize biomarker level as an variable to track the progress of pain relief. 

```{r merging data, echo=FALSE, message = FALSE}
#Left Join on PatientID
mergedCovBioDT <- covariateData[biomarkerData, on = .(PatientID)]
#Count number of observation for each PatientID 
mergedCovBioDT <- mergedCovBioDT[,Count := .N,by = PatientID]
#Exclude any PatientID that does not contain 3 different weeks of observation
mergedCovBioDT <- mergedCovBioDT[Count == 3 & Improved == "Pain improved",]
#Remove the column Count and Improved
mergedCovBioDT[,`:=`(Count = NULL, Improved = NULL)]
#Number of patients to conduct hypothesis test
numOfPatientsForTest <- length(unique(mergedCovBioDT$PatientID))
```

Total of `r numOfPatientsForTest` will be used for the hypothesis testing. These patients showed improvement for the medication and have biomarker level measured at all three occasion.

#Question 2:
Hypothesis: mu is not the same for each week
Parameters: 
 Random variables: Levels of `r biomarkerNames`
 Distribution: t-distribution since the population mu is unknown
 n1 != n2
#Question 3:
Conduct your hypothesis test
 Paired sample t-test to check the mu
 Explain why paired
 

```{r seperate-weeks, echo=FALSE, message=FALSE}
#Seperate biomarkers according to week of observation

#Seperate week 0
Week0 <- mergedCovBioDT[WeeksObs == 0]
#Remove unwanted columns
Week0 <- Week0[,`:=`(PatientID = NULL, Age = NULL, Sex = NULL, Smoker = NULL, VAS.Inclusion = NULL, VAS.12Months = NULL, PainDiff = NULL, WeeksObs = NULL)]

#Seperate week 6
Week6 <- mergedCovBioDT[WeeksObs == 6]
#Remove unwanted columns
Week6 <- Week6[,`:=`(PatientID = NULL, Age = NULL, Sex = NULL, Smoker = NULL, VAS.Inclusion = NULL, VAS.12Months = NULL, PainDiff = NULL, WeeksObs = NULL)]

#Seperate week 52
Week52 <- mergedCovBioDT[WeeksObs == 52]
#Remove unwanted columns
Week52 <- Week52[,`:=`(PatientID = NULL, Age = NULL, Sex = NULL, Smoker = NULL, VAS.Inclusion = NULL, VAS.12Months = NULL, PainDiff = NULL, WeeksObs = NULL)]
```

#Week0 ==  week6
#Week6 == week52
#Week0 == Week52

```{r t-test, echo=FALSE, message=FALSE}
t.test.Biomarkers <- function(data1,data2, biomarker,alpha = 0.05,...) {
  #Extract the data of the biomarker from both data sets as a vector
  data1 <- data1[, get(biomarker)]
  data2 <- data2[, get(biomarker)]
  #Calculate the confidence interval
  confInterval <- 1-alpha
  #Run the t-test 
  res <- t.test(data1, data2, alternative = "two.sided", paired = TRUE, conf.level = confInterval)
  #Extract the p.value
  pValue <- res$p.value
  #return p.value
  return(pValue)
}

alpha <- 0.05
#Running t-test for different combination of weeks for each biomarker
list1 <- lapply(biomarkerNames, FUN = t.test.Biomarkers, data1 = Week0, data2 = Week6, alpha = alpha)
list2 <- lapply(biomarkerNames, FUN = t.test.Biomarkers, data1 = Week6, data2 = Week52, alpha = alpha)
list3 <- lapply(biomarkerNames, FUN = t.test.Biomarkers, data1 = Week0, data2 = Week52, alpha = alpha)

#Amulgamate p.vales with the biomarker
p.values <- data.table(Biomarker = biomarkerNames,
                       C1 = do.call(rbind,list1),
                       C2 = do.call(rbind, list2),
                       C3 = do.call(rbind, list3)) 

#Remaning the columns
setnames(p.values, c("C1.V1","C2.V1","C3.V1"), c("Week 0 and Week 6", "Week 6 and Week 52", "Week 0 and Week 52"))

#Display the table
kable(p.values, caption = "p.vales for each hypothesis test")
```

```{r Ho rejection table, echo=FALSE, warning=FALSE, message=FALSE}
#Redo the table names since they all have the same name
setnames(p.values, c(2:4), c("C1", "C2", "C3"))

p.values.temp <- as.data.frame(p.values)

#Changing the numbers into accept and reject variables
p.values[, `:=` (C1 = factor(ifelse(C1 < alpha, "Reject", "Accept")),
                 C2 = factor(ifelse(C2 < alpha, "Reject", "Accept")),
                 C3 = factor(ifelse(C3 < alpha, "Reject", "Accept")))]

setnames(p.values, c("C1","C2","C3"), c("Week 0 and Week 6", "Week 6 and Week 52", "Week 0 and Week 52"))

kable(p.values, caption = "Acception of p.values")
#datatable(p.values) %>% formatStyle(
#  'V6',
#  backgroundColor = styleEqual(c(0, 1), c('gray', 'yellow'))
#)

```

# Interpretation of the results from the table

#Conclusion

# Q3 a
Potential problem of multiple testing
Calculate the probability of making at least one type I error assuming that your tests are independent and that all null hypotheses are true.

#Q3 b
Bonferroni correction:
  What it is used for?
  How to use it
  Redo the test using this method
                        
                        
                        
                        